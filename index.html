<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 16px;
    }
    h2 { margin-bottom: 12px; }
    textarea {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin-top: 8px;
    }
    button {
      margin-top: 8px;
      margin-right: 8px;
    }
    #out {
      margin-top: 12px;
      white-space: pre-wrap;
      background: #f5f5f5;
      padding: 8px;
      border-radius: 4px;
    }
    #pass-area {
      margin-bottom: 12px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<h2></h2>

<!-- 合言葉エリア（保存後は非表示） -->
<div id="pass-area">
  <input id="pass" type="password" placeholder="合言葉">
  <button onclick="savePass()">保存</button>
  <button onclick="clearPass()">リセット</button>
</div>

<!-- 質問 -->
<textarea
  id="q"
  rows="4"
  placeholder="質問を書く（例：四層構造を200字で要約）"
></textarea>

<br>
<button onclick="send()">送信</button>

<pre id="out"></pre>

<script>
const API_URL =
  "https://phuseqexdczcdwhfskqt.supabase.co/functions/v1/ask";

const PASS_KEY = "bts_pass";
const passArea = document.getElementById("pass-area");
const out = document.getElementById("out");

/* 合言葉欄の表示制御 */
function updatePassArea() {
  const pass = localStorage.getItem(PASS_KEY);
  passArea.style.display = pass ? "none" : "block";
}

/* 初期化 */
updatePassArea();

/* 合言葉保存 */
function savePass() {
  const p = document.getElementById("pass").value;
  if (!p) {
    alert("合言葉を入力してください");
    return;
  }
  localStorage.setItem(PASS_KEY, p);
  updatePassArea();
}

/* 合言葉削除 */
function clearPass() {
  localStorage.removeItem(PASS_KEY);
  updatePassArea();
  alert("合言葉を削除しました");
}

/* 送信 */
async function send() {
  const pass = localStorage.getItem(PASS_KEY);
  if (!pass) {
    alert("先に合言葉を保存してください");
    return;
  }

  const question = document.getElementById("q").value;
  if (!question) return;

  out.textContent = "送信中…";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-ui-passphrase": pass
      },
      body: JSON.stringify({ question })
    });

    const json = await res.json();

    if (!res.ok) {
      out.textContent = "ERROR: " + JSON.stringify(json, null, 2);
      return;
    }

    out.textContent = json.answer ?? "(no answer)";
  } catch (e) {
    out.textContent = "通信エラー";
  }
}
</script>

</body>
</html>
